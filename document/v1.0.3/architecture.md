# FIT.LOL v1.0.3 Architecture (Riot Data Ingestion)

## 개요
v1.0.3는 Riot 데이터를 "요청 시 조회" 중심에서 벗어나, 스케줄러/워커를 통해 지속 수집·적재하는 아키텍처를 추가합니다. 운영 목표는 빠른 조회, 안정적인 수집, 라이엇 레이트리밋 준수입니다.

---

## 아키텍처 개요
```
┌──────────────────────────────────────────────────────────────────────────────┐
│                             Frontend (React, TS)                             │
│  - OIDC 로그인(Keycloak)  - API 호출  - 대시보드/분석 뷰                     │
└───────────────────────────┬──────────────────────────────────────────────────┘
                           │ REST API (Authorization: Bearer)
┌───────────────────────────┴──────────────────────────────────────────────────┐
│                              Backend APIs                                     │
│  ┌───────────────────────┐  ┌───────────────────────┐  ┌───────────────────┐ │
│  │ UserService           │  │ LolAPIService         │  │ AnalysisService   │ │
│  │ - /auth/me, /clan/*   │  │ - 조회용 Riot 라우트   │  │ - 분석/지표 계산   │ │
│  └───────────────────────┘  └───────────────────────┘  └───────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ RiotDataService (Worker + Scheduler)                                    │  │
│  │  - BullMQ 기반 큐/워커                                                  │  │
│  │  - 주기/온디맨드 수집: PUUID, Match IDs, Match Detail                   │  │
│  │  - 재시도/백오프, 배치/샤딩, 캐시, 중복 방지                             │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────┬──────────────────────────────────────────────────┘
                           │
┌───────────────────────────┴──────────────────────────────────────────────────┐
│                                  Infra                                        │
│  Redis (Cache + BullMQ Queue)    |    PostgreSQL (Prisma)                     │
│  - 키: 캐시/큐/락                |    - Matches / Participants / Cursors      │
│  - 레이트리밋 보조               |    - Users / Summoners / JobLogs           │
└───────────────────────────┬──────────────────────────────────────────────────┘
                           │
┌───────────────────────────┴──────────────────────────────────────────────────┐
│                                    IAM                                        │
│                          Keycloak (OIDC, RS256 JWKS)                          │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 핵심 변경점 (v1.0.2 → v1.0.3)
- **RiotDataService** 컴포넌트 신설: BullMQ 워커 + 스케줄러로 Riot 데이터 지속 수집·적재.
- **Queue/Worker 표준화**: 작업 타입/페이로드/재시도/백오프/동시성 정책 정의.
- **스케줄링**: 시간대별 반복 작업(활성 멤버 최근 경기, 랭크 정보, 주간 리포트 등) 도입.
- **DB 보강**: 중복 방지/진행 상황 저장을 위한 `ingestion_cursors`, `job_logs` 제안.
- **API**: 수집 트리거/상태 확인/설정 조회를 위한 관리 엔드포인트 추가(LEADER 전용).

---

## 보안 / RBAC
- 모든 관리/수집 엔드포인트는 `LEADER` 필요.
- 서비스 간 내부 호출은 네트워크 정책 또는 서비스 토큰으로 보호.

---

## 관측성
- Job 실행 로그/메트릭 수집(Prometheus/Grafana 또는 Sentry 옵션).
- 큐 상태 대시보드(Bull Board 등) 연동 권장.

---

## 마이그레이션 가이드(요약)
- Redis, BullMQ 의존성 추가.
- Postgres에 `ingestion_cursors`/`job_logs` 생성.
- Riot API 키/레이트리밋 파라미터/스케줄러 CRON을 환경변수로 관리.
